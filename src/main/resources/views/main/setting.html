<!DOCTYPE html>
<html xmlns:th="http://www/thymeleaf.org" th:replace="base/mainLayout :: mainLayout('feed')">

<!-- Start Content-->
<div class="container-fluid" th:fragment="content">
    <!-- main contents -->
    <main id="site__main" class="2xl:ml-[--w-side]  xl:ml-[--w-side-sm] p-2.5 h-[calc(100vh-var(--m-top))] mt-[--m-top]">

        <div class="max-w-3xl mx-auto">


            <div class="box relative rounded-lg shadow-md">

                <div class="flex md:gap-8 gap-4 items-center md:p-8 p-6 md:pb-4">


                    <div class="relative md:w-20 md:h-20 w-12 h-12 shrink-0">

                        <label for="file" class="cursor-pointer">
                            <img id="img" th:src="@{/assets/images/avatars/avatar-3.jpg}" class="object-cover w-full h-full rounded-full" alt=""/>
                            <input type="file" id="file" class="hidden" />
                        </label>

                        <label for="file" class="md:p-1 p-0.5 rounded-full bg-slate-600 md:border-4 border-white absolute -bottom-2 -right-2 cursor-pointer dark:border-slate-700">

                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="md:w-4 md:h-4 w-3 h-3 fill-white">
                                <path d="M12 9a3.75 3.75 0 100 7.5A3.75 3.75 0 0012 9z" />
                                <path fill-rule="evenodd" d="M9.344 3.071a49.52 49.52 0 015.312 0c.967.052 1.83.585 2.332 1.39l.821 1.317c.24.383.645.643 1.11.71.386.054.77.113 1.152.177 1.432.239 2.429 1.493 2.429 2.909V18a3 3 0 01-3 3h-15a3 3 0 01-3-3V9.574c0-1.416.997-2.67 2.429-2.909.382-.064.766-.123 1.151-.178a1.56 1.56 0 001.11-.71l.822-1.315a2.942 2.942 0 012.332-1.39zM6.75 12.75a5.25 5.25 0 1110.5 0 5.25 5.25 0 01-10.5 0zm12-1.5a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                            </svg>

                            <input id="file" type="file" class="hidden" />

                        </label>

                    </div>

                    <div class="flex-1">
                        <h3 class="md:text-xl text-base font-semibold text-black dark:text-white" id="settingNicknameText"></h3>
                        <p class="text-sm text-blue-600 mt-1 font-normal" id="settingIdText"></p>
                    </div>
                </div>

                <!-- nav tabs -->
                <div class="relative border-b" tabindex="-1" uk-slider="finite: true">

                    <nav class="uk-slider-container overflow-hidden nav__underline px-6 p-0 border-transparent -mb-px">

                        <ul class="uk-slider-items w-[calc(100%+10px)] !overflow-hidden"
                            uk-switcher="connect: #setting_tab ; animation: uk-animation-slide-right-medium, uk-animation-slide-left-medium">

                            <li class="w-auto pr-2.5"> <a href="#"> Description </a> </li>
                            <li class="w-auto pr-2.5"> <a href="#"> Password </a> </li>

                        </ul>

                    </nav>

                    <a class="absolute -translate-y-1/2 top-1/2 left-0 flex items-center w-20 h-full p-2 py-1 justify-start bg-gradient-to-r from-white via-white dark:from-slate-800 dark:via-slate-800" href="#" uk-slider-item="previous"> <ion-icon name="chevron-back" class="text-2xl ml-1"></ion-icon> </a>
                    <a class="absolute right-0 -translate-y-1/2 top-1/2 flex items-center w-20 h-full p-2 py-1 justify-end bg-gradient-to-l from-white via-white dark:from-slate-800 dark:via-slate-800" href="#" uk-slider-item="next">  <ion-icon name="chevron-forward" class="text-2xl mr-1"></ion-icon> </a>

                </div>


                <div id="setting_tab" class="uk-switcher md:py-12 md:px-20 p-6 overflow-hidden text-black text-sm">


                    <!-- tab user basic info -->
                    <div>

                        <div>

                            <form id="userUpdateForm">

                            <div class="space-y-6">
                                    <div class="md:flex items-center gap-10">
                                        <label class="md:w-32 text-right"> Nickname </label>
                                        <div class="flex-1 max-md:mt-4">
                                            <input type="text" id="nickname" name="nickname" placeholder="Nickname" class="lg:w-1/2 w-full">
                                        </div>
                                    </div>

                                    <div class="md:flex items-center gap-10">
                                        <label class="md:w-32 text-right"> Email </label>
                                        <div class="flex-1 max-md:mt-4">
                                            <input type="text" id="email" name="email" placeholder="Email" class="w-full">
                                        </div>
                                    </div>

                                    <div class="md:flex items-center gap-10">
                                        <label class="md:w-32 text-right"> Phone Number </label>
                                        <div class="flex-1 max-md:mt-4">
                                            <input type="text" id="phoneNumber" name="phoneNumber" placeholder="Phone Number" class="w-full">
                                        </div>
                                    </div>

                                    <div class="md:flex items-start gap-10 " hidden>
                                        <label class="md:w-32 text-right"> Avatar </label>
                                        <div class="flex-1 flex items-center gap-5 max-md:mt-4">
                                            <img th:src="@{/assets/images/avatars/avatar-3.jpg}" alt="" class="w-10 h-10 rounded-full">
                                            <button type="submit" class="px-4 py-1 rounded-full bg-slate-100/60 border dark:bg-slate-700 dark:border-slate-600 dark:text-white"> Change</button>
                                        </div>
                                    </div>
                            </div>
                            </form>

                            <div class="flex items-center gap-4 mt-16 lg:pl-[10.5rem]">
                                <button type="button" class="button lg:px-6 bg-secondery max-md:flex-1" onclick="locationReload()"> Cancle</button>
                                <button type="button" class="button lg:px-10 bg-primary text-white max-md:flex-1" onclick="updateUser();"> Save <span class="ripple-overlay"></span></button>
                            </div>

                        </div>

                    </div>

                    <!-- tab password-->
                    <div>

                        <div>
                            <form id="updatePasswordForm">

                            <div class="space-y-6 max-w-lg mx-auto">
                                <div class="md:flex items-center gap-16 justify-between max-md:space-y-3">
                                    <label class="md:w-40 text-right"> Current Password </label>
                                    <div class="flex-1 max-md:mt-4">
                                        <input type="password" id="currentPassword" name="currentPassword" placeholder="******" class="w-full">
                                    </div>
                                </div>

                                <div class="md:flex items-center gap-16 justify-between max-md:space-y-3">
                                    <label class="md:w-40 text-right"> New password </label>
                                    <div class="flex-1 max-md:mt-4">
                                        <input type="password" id="newPassword" name="newPassword" placeholder="******" class="w-full">
                                    </div>
                                </div>

                                <div class="md:flex items-center gap-16 justify-between max-md:space-y-3">
                                    <label class="md:w-40 text-right"> Repeat password </label>
                                    <div class="flex-1 max-md:mt-4">
                                        <input type="password" id="newPasswordCheck" name="newPasswordCheck" placeholder="******" class="w-full">
                                    </div>
                                </div>
                            </div>
                            </form>

                            <div class="flex items-center justify-center gap-4 mt-16">
                                <button type="button" class="button lg:px-6 bg-secondery max-md:flex-1" onclick="locationReload()"> Cancle</button>
                                <button type="button" class="button lg:px-10 bg-primary text-white max-md:flex-1" onclick="updatePassword();"> Save</button>
                            </div>

                        </div>

                    </div>


                </div>


            </div>


        </div>

    </main>
</div>

<!-- css -->
<th:block th:fragment="css">

</th:block>

<!-- Scripts -->
<th:block th:fragment="scripts">
    <script th:src="@{/assets/js/feed.js}"></script>

    <script th:inline="javascript" th:fragment="scripts">
        let userPasswordUri = /*[[@{${GlobalURI.USER_PW}}]]*/;

        $(document).ready(function(){
            checkTokenExpired();

            $('#currentPassword').val("");
            $('#newPassword').val("");
            $('#newPasswordCheck').val("");

            let accessToken = window.localStorage.getItem(accessTokenString);

            let requestEndPoint = userRequestUri + "/" + accessToken;

            $.ajax({
                url: requestEndPoint,
                method: "GET",
                dataType: "JSON",
                contentType: 'application/json',
                beforeSend: function(request) {
                },
                success: function(response){
                    $('#settingNicknameText').text(response.nickname);
                    $('#settingIdText').text(response.userId);
                    if(response.nickname != null && response.nickname !== "") $('#nickname').attr('placeholder', response.nickname);
                    if(response.email != null && response.email !== "") $('#email').attr('placeholder', response.email);
                    if(response.phoneNumber != null && response.phoneNumber !== "") $('#phoneNumber').attr('placeholder', response.phoneNumber);
                    $('#nickname').val(response.nickname);
                    $('#email').val(response.email);
                    $('#phoneNumber').val(response.phoneNumber);
                },
                complete: function(response){
                },
                error: function(response){
                    let errorModal = $("#errorModal");

                    UIkit.modal(errorModal).show();
                }
            });
        });

        function updateUser(){
            let inputEmail = $('#email').val();
            let emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!(inputEmail == null || inputEmail === "") && !emailPattern.test(inputEmail)) {
                alert("Email을 확인해주세요");
                return ;
            }

            updateUserRequest();
        }

        function updateUserRequest(){
            let formData = $("#userUpdateForm").serializeArray();
            let formObj = {};

            $.map(formData, function(n, i){
                formObj[n['name']] = n['value'];
            });

            formObj[accessTokenString] = window.localStorage.getItem(accessTokenString);

            $.ajax({
                url: userRequestUri,
                method: "PUT",
                data: JSON.stringify(formObj),
                dataType: "JSON",
                contentType: 'application/json',
                beforeSend: function(request) {
                },
                success: function(response){
                    locationReload();
                },
                complete: function(response){
                },
                error: function(response){
                    if (response.status.toString().startsWith('4')){
                        let responseString = response.responseJSON;

                        alert(responseString);
                    } else {
                        let errorModal = $("#errorModal");

                        UIkit.modal(errorModal).show();
                    }
                }
            });
        }

        function updatePassword(){
            let currentPassword = $('#currentPassword').val();

            let inputPassword = $('#newPassword').val();

            let inputPasswordConfirm = $('#newPasswordCheck').val();

            if (checkEmpty(currentPassword) || checkEmpty(inputPassword) || checkEmpty(inputPasswordConfirm)
                || checkValidation(/^(?=.*[a-zA-Z])(?=.*[0-9])[a-zA-Z0-9!@#$%^&*()-_=+~`[\]{}|;:'",<.>/?]{8,20}$/, inputPassword)
                || inputPassword != inputPasswordConfirm) {
                alert("비밀번호를 확인해주세요");
                return null;
            }

            updatePasswordRequest();
        }

        function updatePasswordRequest(){
            let formData = $("#updatePasswordForm").serializeArray();
            let formObj = {};

            $.map(formData, function(n, i){
                formObj[n['name']] = n['value'];
            });

            formObj[accessTokenString] = window.localStorage.getItem(accessTokenString);

            $.ajax({
                url: userPasswordUri,
                method: "PUT",
                data: JSON.stringify(formObj),
                dataType: "JSON",
                contentType: 'application/json',
                beforeSend: function(request) {
                },
                success: function(response){
                    locationReload();
                },
                complete: function(response){
                },
                error: function(response){
                    if (response.status.toString().startsWith('4')){
                        let responseString = response.responseJSON;

                        alert(responseString);
                    } else {
                        let errorModal = $("#errorModal");

                        UIkit.modal(errorModal).show();
                    }
                }
            });
        }

        function locationReload(){
            location.reload();
        }
    </script>

</th:block>

</body>
</html>